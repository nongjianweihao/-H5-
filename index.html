<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç‚¹ç‡ƒä½ çš„è¿åŠ¨å°å®‡å®™ - è·³ç»³ä½“èƒ½æŒ‘æˆ˜</title>
    <!-- å¼•å…¥Tailwind CSSæ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥Chart.jsç”¨äºç»˜åˆ¶é›·è¾¾å›¾ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥Tone.jsç”¨äºç”ŸæˆéŸ³æ•ˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* ä½¿ç”¨è‡ªå®šä¹‰å­—ä½“ï¼Œè®©é¡µé¢æ›´æœ‰è®¾è®¡æ„Ÿ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans SC', sans-serif;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº® */
        }
        /* å®šä¹‰é¡µé¢åˆ‡æ¢çš„åŠ¨ç”»æ•ˆæœ */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            opacity: 0;
            transform: scale(1.05);
            pointer-events: none; /* é»˜è®¤é¡µé¢ä¸å¯äº¤äº’ */
        }
        .page.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto; /*æ¿€æ´»çš„é¡µé¢å¯äº¤äº’ */
        }
        /* è‡ªå®šä¹‰æŒ‰é’®æ ·å¼ï¼Œå¢åŠ åŠ¨æ„Ÿ */
        .btn-energize {
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 5, 0.4);
        }
        .btn-energize:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 107, 5, 0.6);
        }
        .btn-energize:active {
            transform: translateY(1px);
        }
        /* æ•æ·æŒ‘æˆ˜ä¸­åœ†ç‚¹çš„æ ·å¼ */
        .dot {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }
        .dot:active {
            transform: scale(0.9);
        }
        /* æ—¶æœºæŒ‘æˆ˜ä¸­ç§»åŠ¨æ¡çš„æ ·å¼ */
        #timing-bar {
            position: absolute;
            left: 0;
            height: 100%;
            background-color: #fb923c; /* æ©™è‰² */
            animation: move-bar 2s linear infinite alternate;
        }
        @keyframes move-bar {
            from { left: 0; }
            to { left: calc(100% - 20px); }
        }
        /* è¥é”€å¼¹çª—æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 999;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white; 
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            color: #334155; /* text-slate-700 */
        }
        .modal.active .modal-content {
            transform: scale(1);
        }
        /* æ–°å¢ï¼šæŠ½å¥–è½¬ç›˜æ ·å¼ */
        #lottery-wheel {
            position: relative;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: 8px solid #f59e0b;
            background: conic-gradient(
                #f87171 0deg 60deg,
                #60a5fa 60deg 120deg,
                #34d399 120deg 180deg,
                #f87171 180deg 240deg,
                #60a5fa 240deg 300deg,
                #a78bfa 300deg 360deg
            );
            transition: transform 5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .prize {
            position: absolute;
            width: 100%;
            height: 100%;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
        }
        .prize-text {
            position: absolute;
            left: 50%;
            top: 20px;
            transform-origin: bottom center;
            transform: translateX(-50%);
            font-size: 14px;
        }
        #spin-btn {
            position: absolute;
            width: 80px;
            height: 80px;
            background: #f59e0b;
            border-radius: 50%;
            border: 4px solid white;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        #spin-btn::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 15px 20px;
            border-style: solid;
            border-color: transparent transparent #f59e0b;
        }
    </style>
</head>
<body class="overflow-hidden bg-orange-50 text-slate-800">

    <div id="app-container" class="relative w-full h-screen max-w-md mx-auto bg-orange-100">

        <!-- Page 1: å¯åŠ¨é¡µ -->
        <div id="start-page" class="page active flex flex-col justify-center items-center text-center p-8 bg-gradient-to-br from-orange-300 to-amber-200">
            <div class="flex-grow flex flex-col justify-center items-center">
                <h1 class="text-5xl font-black tracking-wider text-orange-600 drop-shadow-lg" style="text-shadow: 1px 1px 2px rgba(255,255,255,0.5);">ä½ çš„ååº”åŠ›ï¼Œæ˜¯ç‹è€…è¿˜æ˜¯é’é“œï¼Ÿ</h1>
                <p class="mt-4 text-xl text-slate-800 font-bold">15ç§’ï¼ŒAIç®—æ³•æµ‹å‡ºä½ çš„éšè—è¿åŠ¨æ½œåŠ›ï¼</p>
            </div>
            <button id="start-challenge-btn" class="btn-energize w-full py-4 bg-orange-500 rounded-xl text-xl font-bold text-white">æŒ‘æˆ˜ç‹è€…çº§å¤©èµ‹ï¼</button>
            <!-- å“ç‰Œç½²å -->
            <div class="absolute bottom-4 text-xs text-slate-500">å—å®å¸‚çˆ±å¾·åæ€è·³ç»³ | AIæ™ºèƒ½è¿åŠ¨ç®—æ³•ç”Ÿæˆ</div>
        </div>

        <!-- Page 2: èº«ä»½é€‰æ‹©é¡µ -->
        <div id="choice-page" class="page flex flex-col justify-center items-center p-8 bg-gradient-to-b from-orange-100 to-amber-200">
            <h2 class="text-3xl font-bold mb-12 text-slate-700">è¯·é€‰æ‹©ä½ çš„èº«ä»½</h2>
            <div class="w-full space-y-6">
                <button data-type="child" class="user-choice-btn w-full py-8 bg-blue-500 rounded-xl text-2xl text-white font-bold transition hover:bg-blue-600 transform hover:scale-105">
                    <span class="text-4xl">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
                    <p>æˆ‘æ˜¯å®¶é•¿ï¼Œä¸ºå­©å­æµ‹å¤©èµ‹</p>
                </button>
                <button data-type="adult" class="user-choice-btn w-full py-8 bg-purple-500 rounded-xl text-2xl text-white font-bold transition hover:bg-purple-600 transform hover:scale-105">
                    <span class="text-4xl">ğŸ”¥</span>
                    <p>æˆ‘ä¸ºè‡ªå·±æµ‹æ½œèƒ½</p>
                </button>
            </div>
        </div>

        <!-- Page 3: æŒ‘æˆ˜é¡µ -->
        <div id="challenge-page" class="page flex flex-col justify-between p-4 bg-orange-100">
            <!-- æŒ‘æˆ˜é€šç”¨å¤´éƒ¨ -->
            <div class="text-center p-2 bg-white/70 rounded-lg shadow">
                <h3 id="challenge-title" class="text-xl font-bold"></h3>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                    <div id="challenge-timer-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 100%"></div>
                </div>
            </div>
            
            <!-- æŒ‘æˆ˜å†…å®¹å®¹å™¨ -->
            <div id="challenge-content" class="flex-grow relative mt-4 rounded-lg bg-white/70 shadow-inner">
                <!-- æ•æ·æŒ‘æˆ˜ -->
                <div id="agility-challenge" class="hidden w-full h-full"></div>
                <!-- è€åŠ›æŒ‘æˆ˜ -->
                <div id="endurance-challenge" class="hidden w-full h-full flex flex-col justify-center items-center">
                    <p class="text-lg mb-4">10ç§’å†…ï¼Œç–¯ç‹‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼</p>
                    <button id="endurance-btn" class="w-40 h-40 bg-red-500 rounded-full text-5xl font-black text-white transition transform active:scale-90 flex justify-center items-center shadow-lg shadow-red-500/50">ç‚¹æˆ‘!</button>
                    <p id="endurance-count" class="mt-4 text-3xl font-bold">0</p>
                </div>
                <!-- æ—¶æœºæŒ‘æˆ˜ -->
                <div id="timing-challenge" class="hidden w-full h-full flex flex-col justify-center items-center p-4">
                    <p class="text-lg mb-8 text-center">å½“ç§»åŠ¨æ–¹å—è¿›å…¥<span class="text-green-500 font-bold">ç»¿è‰²åŒºåŸŸ</span>æ—¶ï¼Œç«‹å³ç‚¹å‡»ï¼</p>
                    <div class="w-full h-12 bg-gray-200 rounded-lg relative overflow-hidden">
                        <div class="absolute h-full bg-green-500/30" style="left: 40%; width: 20%;"></div>
                        <div id="timing-bar" class="w-5 h-full rounded"></div>
                    </div>
                    <button id="timing-btn" class="btn-energize w-full mt-12 py-4 bg-orange-500 rounded-xl text-xl text-white font-bold">å°±ç°åœ¨ï¼</button>
                    <p id="timing-feedback" class="mt-4 text-xl font-bold h-8"></p>
                </div>
            </div>
        </div>

        <!-- Page 4: åŠ è½½é¡µ -->
        <div id="loading-page" class="page flex flex-col justify-center items-center bg-gradient-to-br from-orange-300 to-amber-200">
            <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-orange-500"></div>
            <p id="loading-text" class="mt-4 text-lg text-slate-700">æ­£åœ¨åˆ†æä½ çš„è¿åŠ¨ç»†èƒ...</p>
        </div>

        <!-- Page 5: ç»“æœé¡µ -->
        <div id="result-page" class="page flex flex-col p-4 bg-gradient-to-br from-orange-100 to-amber-100 overflow-y-auto">
            <div class="text-center">
                <h2 class="text-3xl font-black text-orange-600">ä½ çš„è¿åŠ¨æ½œèƒ½æŠ¥å‘Š</h2>
                <!-- å“ç‰Œå‰ç½® -->
                <h3 class="text-lg font-bold mt-2 text-slate-700">å—å®å¸‚çˆ±å¾·åæ€è·³ç»³</h3>
            </div>
            <div class="my-4 bg-white/60 p-4 rounded-xl text-center shadow">
                <p class="text-lg">ä½ çš„ç§°å·æ˜¯</p>
                <h3 id="result-title" class="text-4xl font-bold text-orange-500 my-2">--</h3>
                <p id="result-description" class="text-slate-600">--</p>
                 <!-- ç‚«è€€æµ·æŠ¥å¼•å¯¼ (MODIFIED) -->
                <p class="text-sm font-bold text-red-500 animate-pulse mt-2">æˆªå›¾ï¼Œå¿«æŠŠè£èª‰åˆ†äº«å‡ºå»å§ï¼</p>
            </div>
            
            <!-- å†…å®¹é¡ºåºè°ƒæ•´ -->
            <div class="my-4 bg-white/60 p-4 rounded-xl shadow">
                <h4 class="text-xl font-bold text-center mb-2">èƒ½åŠ›é›·è¾¾å›¾</h4>
                <canvas id="result-chart"></canvas>
            </div>
            <div class="my-4 bg-white/60 p-4 rounded-xl shadow">
                <h4 class="text-xl font-bold text-center mb-2">ä¸“ä¸šå»ºè®®</h4>
                <p id="result-suggestion" class="text-slate-600 text-left">--</p>
            </div>
            
            <div class="space-y-4 mt-auto pt-2">
                 <p class="text-center text-red-500 font-bold mb-2 animate-pulse">æœ¬å‘¨ä»…å‰© <span id="spots-left">7</span> ä¸ªå…è´¹ä½“éªŒåé¢ï¼</p>
                 <button id="open-lead-form-btn" class="w-full py-3 bg-green-500 rounded-xl text-lg text-white font-bold transition hover:bg-green-600">é¢†å–å…è´¹ä½“éªŒè¯¾</button>
                 <button id="open-share-modal-btn" class="w-full py-3 bg-blue-500 rounded-xl text-lg text-white font-bold transition hover:bg-blue-600">åˆ†äº«æŒ‘æˆ˜ï¼Œèµ¢å–å¤§å¥–</button>
            </div>

             <!-- å†…å®¹é¡ºåºè°ƒæ•´ -->
            <div class="my-4 bg-white/60 p-4 rounded-xl shadow">
                <h4 class="text-xl font-bold text-center mb-2">æŒ‘æˆ˜æ’è¡Œæ¦œ</h4>
                <div id="leaderboard" class="space-y-2">
                    <!-- JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="my-4 bg-white/60 p-4 rounded-xl shadow">
                <h4 class="text-xl font-bold text-center mb-2">å®¶é•¿å¥½è¯„</h4>
                <div class="space-y-2">
                    <p class="text-slate-600 text-sm italic text-center">â€œå­©å­åœ¨è¿™é‡Œå­¦è·³ç»³åï¼Œä¸ä»…é•¿é«˜äº†ï¼Œä¹Ÿæ›´è‡ªä¿¡äº†ï¼â€ - å­¦å‘˜å®¶é•¿ ç‹å¥³å£«</p>
                    <p class="text-slate-600 text-sm italic text-center">â€œè¯¾ç¨‹å¾ˆæœ‰è¶£ï¼Œå­©å­ä»¥å‰ä¸çˆ±è¿åŠ¨ï¼Œç°åœ¨æ¯å‘¨éƒ½ç›¼ç€æ¥ä¸Šè¯¾ï¼â€ - å­¦å‘˜å®¶é•¿ æå…ˆç”Ÿ</p>
                </div>
            </div>

            <!-- æƒå¨ç½²å -->
            <div class="text-center text-xs text-slate-500 mt-auto pb-2">å—å®å¸‚çˆ±å¾·åæ€è·³ç»³ | AIæ™ºèƒ½è¿åŠ¨ç®—æ³•ç”Ÿæˆ <br> <span id="busuanzi_container_site_pv">æœ¬æ´»åŠ¨å·²è¢«æµè§ˆ <span id="busuanzi_value_site_pv"></span> æ¬¡</span></div>
        </div>
    </div>

    <!-- è¥é”€å¼¹çª— - é¢†å–ä½“éªŒè¯¾ -->
    <div id="lead-form-modal" class="modal">
        <div class="modal-content text-center">
             <h3 class="text-2xl font-bold mb-4 text-green-500">é”å®šåé¢ï¼</h3>
             <p class="mb-4">è¯·é•¿æŒ‰è¯†åˆ«ä¸‹æ–¹äºŒç»´ç </p>
             <p class="mb-4 font-bold">æ·»åŠ  å—å®å¸‚çˆ±å¾·åæ€è·³ç»³ è€å¸ˆå¾®ä¿¡ï¼</p>
             <img id="qr-code-img" src="" alt="å¾®ä¿¡äºŒç»´ç " class="w-48 h-48 mx-auto rounded-lg">
             <button id="close-qrcode-modal-btn" class="mt-6 w-full py-3 bg-gray-500 text-white rounded-xl text-lg font-bold">å…³é—­</button>
        </div>
    </div>

    <!-- è¥é”€å¼¹çª— - åˆ†äº«å¼•å¯¼ -->
    <div id="share-modal" class="modal">
        <div class="modal-content text-center">
            <h3 class="text-2xl font-bold mb-2 text-blue-500">åˆ†äº«èµ¢å¤§å¥–ï¼</h3>
            <!-- Prize Images -->
            <p class="text-sm text-slate-500 mb-2">åˆ†äº«åå‚ä¸æŠ½å¥–ï¼Œèµ¢å–ä»¥ä¸‹å¥½ç¤¼ï¼</p>
            <div class="flex justify-around items-center my-4">
                <div class="text-center">
                    <img src="https://pic1.imgdb.cn/item/68a0b6d558cb8da5c8289f7a.png" alt="ä¸“ä¸šè·³ç»³" class="w-20 h-20 object-cover rounded-lg shadow-md mx-auto" onerror="this.onerror=null;this.src='https://placehold.co/80x80/f87171/ffffff?text=è·³ç»³';">
                    <p class="text-xs mt-1 font-bold">ä¸“ä¸šè·³ç»³</p>
                </div>
                <div class="text-center">
                    <img src="https://pic1.imgdb.cn/item/68a0b6ce58cb8da5c8289f79.png" alt="é™é‡ç¤¼ç›’" class="w-20 h-20 object-cover rounded-lg shadow-md mx-auto" onerror="this.onerror=null;this.src='https://placehold.co/80x80/a78bfa/ffffff?text=ç¤¼ç›’';">
                    <p class="text-xs mt-1 font-bold">é™é‡ç¤¼ç›’</p>
                </div>
                <div class="text-center">
                    <img src="https://pic1.imgdb.cn/item/68a0b6c258cb8da5c8289f78.png" alt="ä»£é‡‘åˆ¸" class="w-20 h-20 object-cover rounded-lg shadow-md mx-auto" onerror="this.onerror=null;this.src='https://placehold.co/80x80/34d399/ffffff?text=ä»£é‡‘åˆ¸';">
                    <p class="text-xs mt-1 font-bold">100å…ƒä»£é‡‘åˆ¸</p>
                </div>
            </div>
            <div class="my-4 p-2 border-2 border-dashed border-slate-300 rounded-lg cursor-pointer" id="share-text-container">
                <p class="text-left text-sm font-bold mb-1">åˆ†äº«æ–‡æ¡ˆ (ç‚¹å‡»å¤åˆ¶)</p>
                <p class="text-left text-sm text-slate-600" id="dynamic-share-text"></p>
            </div>
             <div class="my-4">
                 <p class="text-left text-sm font-bold mb-1">åˆ†äº«æ­¥éª¤ï¼š</p>
                 <p class="text-left text-sm text-slate-600">1. ç‚¹å‡»ä¸Šæ–¹æ–‡æ¡ˆå®Œæˆå¤åˆ¶ã€‚<br>2. åˆ†äº«åˆ°æœ‹å‹åœˆæˆ–å¾®ä¿¡ç¾¤ã€‚<br>3. é‚€è¯·å¥½å‹æ¥æŒ‘æˆ˜ï¼</p>
             </div>
            <button id="share-now-btn" class="w-full py-3 bg-blue-500 text-white rounded-xl text-lg font-bold">ç«‹å³åˆ†äº«ï¼Œå‚ä¸æŠ½å¥–</button>
            <button id="close-share-modal-btn" class="mt-4 text-gray-400 text-sm">æš‚ä¸å‚ä¸</button>
        </div>
    </div>
    
    <!-- æŠ½å¥–å¼¹çª— -->
    <div id="lottery-modal" class="modal">
        <div class="modal-content flex flex-col items-center">
            <h3 class="text-2xl font-bold mb-4 text-amber-500">å¹¸è¿å¤§è½¬ç›˜</h3>
            <div id="lottery-container" class="relative flex justify-center items-center my-4">
                <div id="lottery-wheel">
                    <!-- JSåŠ¨æ€ç”Ÿæˆå¥–å“ -->
                </div>
                <button id="spin-btn">æŠ½å¥–</button>
            </div>
            <!-- FIX: è°ƒæ•´å¸ƒå±€ï¼Œé˜²æ­¢é®æŒ¡ -->
            <p id="lottery-result" class="mt-4 mb-4 font-bold text-lg min-h-[1.75rem]"></p>
            <button id="close-lottery-modal-btn" class="w-full py-2 bg-gray-500 text-white rounded-lg hidden">å…³é—­</button>
        </div>
    </div>

    <!-- æ–°å¢ï¼šä¸è’œå­è®¿é—®é‡ç»Ÿè®¡è„šæœ¬ -->
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <script>
        // --- DOMå…ƒç´ è·å– ---
        const pages = document.querySelectorAll('.page');
        const startBtn = document.getElementById('start-challenge-btn');
        const choiceBtns = document.querySelectorAll('.user-choice-btn');
        const challengeTitle = document.getElementById('challenge-title');
        const challengeTimerBar = document.getElementById('challenge-timer-bar');
        
        const agilityContainer = document.getElementById('agility-challenge');
        const enduranceContainer = document.getElementById('endurance-challenge');
        const enduranceBtn = document.getElementById('endurance-btn');
        const enduranceCount = document.getElementById('endurance-count');
        const timingContainer = document.getElementById('timing-challenge');
        const timingBtn = document.getElementById('timing-btn');
        const timingBar = document.getElementById('timing-bar');
        const timingFeedback = document.getElementById('timing-feedback');

        const resultTitle = document.getElementById('result-title');
        const resultDescription = document.getElementById('result-description');
        const resultSuggestion = document.getElementById('result-suggestion');
        const loadingText = document.getElementById('loading-text');
        const spotsLeftEl = document.getElementById('spots-left');
        const leaderboardContainer = document.getElementById('leaderboard');

        const leadFormModal = document.getElementById('lead-form-modal');
        const shareModal = document.getElementById('share-modal');
        const openLeadFormBtn = document.getElementById('open-lead-form-btn');
        const openShareModalBtn = document.getElementById('open-share-modal-btn');
        const closeShareModalBtn = document.getElementById('close-share-modal-btn');
        const closeQrcodeModalBtn = document.getElementById('close-qrcode-modal-btn');
        const qrCodeImg = document.getElementById('qr-code-img');
        const shareNowBtn = document.getElementById('share-now-btn');
        const shareTextContainer = document.getElementById('share-text-container');
        const dynamicShareText = document.getElementById('dynamic-share-text');
        
        const lotteryModal = document.getElementById('lottery-modal');
        const lotteryWheel = document.getElementById('lottery-wheel');
        const spinBtn = document.getElementById('spin-btn');
        const lotteryResult = document.getElementById('lottery-result');
        const closeLotteryModalBtn = document.getElementById('close-lottery-modal-btn');

        // --- æ¸¸æˆçŠ¶æ€å˜é‡ ---
        let userType = 'adult'; 
        let scores = { agility: 0, endurance: 0, timing: 0 };
        let totalScore = 0;
        let currentChallengeIndex = 0;
        const challenges = ['agility', 'endurance', 'timing'];
        let timerInterval;
        let synth; 
        let isShareInstructed = false; 

        // --- åˆå§‹åŒ–éŸ³æ•ˆ ---
        function initAudio() {
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            synth = new Tone.Synth().toDestination();
        }

        // --- é¡µé¢åˆ‡æ¢å‡½æ•° ---
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.toggle('active', page.id === pageId);
            });
        }
        
        // --- å¼¹çª—æ§åˆ¶ ---
        function toggleModal(modal, show) {
            modal.classList.toggle('active', show);
        }

        // --- æŒ‘æˆ˜æµç¨‹æ§åˆ¶ ---
        function startNextChallenge() {
            if (currentChallengeIndex < challenges.length) {
                const challengeName = challenges[currentChallengeIndex];
                switch (challengeName) {
                    case 'agility': startAgilityChallenge(); break;
                    case 'endurance': startEnduranceChallenge(); break;
                    case 'timing': startTimingChallenge(); break;
                }
                currentChallengeIndex++;
            } else {
                showLoadingAndResults();
            }
        }

        // --- æŒ‘æˆ˜1: æ•æ· ---
        function startAgilityChallenge() {
            challengeTitle.textContent = 'æŒ‘æˆ˜1: æ•æ·ååº”';
            agilityContainer.classList.remove('hidden');
            enduranceContainer.classList.add('hidden');
            timingContainer.classList.add('hidden');
            
            let duration = 10000;
            let nextDot = 1;
            let score = 0;
            
            function createDot() {
                if (agilityContainer.children.length > 0) return; 
                if (nextDot > 10) return;
                const dot = document.createElement('div');
                dot.className = 'dot';
                dot.textContent = nextDot;
                const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500'];
                dot.classList.add(colors[Math.floor(Math.random() * colors.length)]);
                dot.style.top = `${Math.random() * 85 + 5}%`;
                dot.style.left = `${Math.random() * 85 + 5}%`;
                
                dot.onclick = () => {
                    synth.triggerAttackRelease("C5", "8n");
                    score++;
                    dot.remove();
                    setTimeout(createDot, 100); 
                };
                
                agilityContainer.appendChild(dot);
                nextDot++;
            }
            
            createDot();
            runTimer(duration, () => {
                scores.agility = score * 10;
                agilityContainer.innerHTML = '';
                startNextChallenge();
            });
        }

        // --- æŒ‘æˆ˜2: è€åŠ› ---
        function startEnduranceChallenge() {
            challengeTitle.textContent = 'æŒ‘æˆ˜2: è€åŠ›ç‚¹å‡»';
            agilityContainer.classList.add('hidden');
            enduranceContainer.classList.remove('hidden');
            timingContainer.classList.add('hidden');

            let duration = 10000;
            let clicks = 0;
            enduranceCount.textContent = '0';
            
            const clickHandler = () => {
                clicks++;
                enduranceCount.textContent = clicks;
                synth.triggerAttackRelease("E4", "16n");
                enduranceBtn.style.transform = `scale(${1 + clicks * 0.005})`;
            };
            enduranceBtn.addEventListener('click', clickHandler);
            
            runTimer(duration, () => {
                enduranceBtn.removeEventListener('click', clickHandler);
                scores.endurance = Math.min(100, clicks * (userType === 'child' ? 2.5 : 2));
                enduranceBtn.style.transform = 'scale(1)';
                startNextChallenge();
            });
        }

        // --- æŒ‘æˆ˜3: æ—¶æœº ---
        function startTimingChallenge() {
            challengeTitle.textContent = 'æŒ‘æˆ˜3: æ—¶æœºæŒæ§';
            agilityContainer.classList.add('hidden');
            enduranceContainer.classList.add('hidden');
            timingContainer.classList.remove('hidden');
            
            let attempts = 0;
            let totalScore = 0;
            const maxAttempts = 3;
            timingFeedback.textContent = `ç¬¬ ${attempts + 1} / ${maxAttempts} æ¬¡`;

            function checkTiming() {
                if (attempts >= maxAttempts) return;
                
                const barRect = timingBar.getBoundingClientRect();
                const containerRect = timingBar.parentElement.getBoundingClientRect();
                const barPosition = (barRect.left - containerRect.left) / containerRect.width * 100;
                
                let score = 0;
                if (barPosition >= 40 && barPosition <= 60) {
                    const distanceToCenter = Math.abs(barPosition - 50);
                    score = Math.round(100 - distanceToCenter * 10);
                    timingFeedback.textContent = `å®Œç¾! +${score}`;
                    synth.triggerAttackRelease("G5", "8n");
                } else {
                    timingFeedback.textContent = 'å¤±è¯¯!';
                    synth.triggerAttackRelease("C3", "8n");
                }
                totalScore += score;
                attempts++;
                
                if (attempts < maxAttempts) {
                    setTimeout(() => {
                        timingFeedback.textContent = `ç¬¬ ${attempts + 1} / ${maxAttempts} æ¬¡`;
                    }, 1000);
                } else {
                    timingBtn.removeEventListener('click', checkTiming);
                    scores.timing = Math.round(totalScore / maxAttempts);
                    setTimeout(startNextChallenge, 1500);
                }
            }
            
            timingBtn.addEventListener('click', checkTiming);
        }

        // --- é€šç”¨è®¡æ—¶å™¨ ---
        function runTimer(duration, onComplete) {
            clearInterval(timerInterval);
            let startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsedTime = Date.now() - startTime;
                const progress = 1 - (elapsedTime / duration);
                challengeTimerBar.style.width = `${Math.max(0, progress * 100)}%`;
                if (progress <= 0) {
                    clearInterval(timerInterval);
                    onComplete();
                }
            }, 50);
        }
        
        // --- æ˜¾ç¤ºåŠ è½½å¹¶è®¡ç®—ç»“æœ ---
        function showLoadingAndResults() {
            showPage('loading-page');
            let counter = 0;
            const texts = ["æ­£åœ¨åˆ†æä½ çš„è¿åŠ¨ç»†èƒ...", "åŒ¹é…å…¨çƒè¿åŠ¨æ•°æ®åº“...", "ä½ çš„æ½œèƒ½æŠ¥å‘Šå³å°†ç”Ÿæˆ!"];
            const loadingInterval = setInterval(() => {
                counter++;
                if (counter <= 2) {
                    loadingText.textContent = texts[counter];
                } else {
                    clearInterval(loadingInterval);
                    generateResult();
                    showPage('result-page');
                }
            }, 1200);
        }

        // --- ç”Ÿæˆç»“æœ ---
        function generateResult() {
            totalScore = Math.round((scores.agility + scores.endurance + scores.timing) / 3);
            let title, description, suggestion;
            let beatRatio = 75 + Math.floor(totalScore / 10); 

            if (totalScore > 85) {
                title = userType === 'child' ? "è¿åŠ¨å°è¶…äºº" : "å¤©èµ‹å¼‚ç¦€è€…";
                description = `ç»¼åˆå¾—åˆ† ${totalScore}ï¼ä½ å‡»è´¥äº†å…¨å›½ ${beatRatio}% çš„æŒ‘æˆ˜è€…ï¼`;
            } else if (totalScore > 60) {
                title = userType === 'child' ? "æ´»åŠ›å°å¥å°†" : "è¿åŠ¨æ½œåŠ›è‚¡";
                description = `ç»¼åˆå¾—åˆ† ${totalScore}ï¼ä½ å‡»è´¥äº†å…¨å›½ ${beatRatio}% çš„æŒ‘æˆ˜è€…ï¼`;
            } else {
                title = userType === 'child' ? "æˆé•¿å°èŒèŠ½" : "æ½œåŠ›å¾…å‘æ˜";
                description = `ç»¼åˆå¾—åˆ† ${totalScore}ï¼ä½ çš„è¿åŠ¨ç»†èƒæ­£åœ¨æ²‰ç¡ï¼Œæ˜¯æ—¶å€™å”¤é†’å®ƒä»¬äº†ï¼`;
            }

            // ä¼˜åŒ–ä¸“ä¸šå»ºè®®æ–‡æ¡ˆ
            if (userType === 'child') {
                if (totalScore > 85) {
                    suggestion = `å­©å­çš„å¤©èµ‹éå¸¸çªå‡ºï¼æˆ‘ä»¬çš„ã€è·³ç»³ä½“èƒ½è¯¾ã€‘èƒ½å¸®ä»–ä¼˜ä¸­æ›´ä¼˜ï¼Œåœ¨èŠ±æ ·è·³ç»³å’Œä¸“ä¸šæŠ€å·§ä¸Šå–å¾—çªç ´ã€‚è¯¾ç¨‹æ—¢ç§‘å­¦åˆæœ‰è¶£å‘³ï¼Œèƒ½å……åˆ†æ¿€å‘å­©å­çš„è¿åŠ¨çƒ­æƒ…ï¼`;
                } else if (totalScore > 60) {
                    suggestion = `å­©å­å¾ˆæœ‰æ½œåŠ›ï¼åœ¨ç”Ÿé•¿å‘è‚²çš„é»„é‡‘æœŸï¼Œä¸“ä¸šçš„æŒ‡å¯¼èƒ½äº‹åŠåŠŸå€ã€‚æˆ‘ä»¬çš„ã€è·³ç»³ä½“èƒ½è¯¾ã€‘å°†ç§‘å­¦è®­ç»ƒä¸è¶£å‘³æ¸¸æˆç»“åˆï¼Œèƒ½æœ‰æ•ˆæå‡åè°ƒæ€§ã€è€åŠ›ï¼Œæ¿€å‘è¿åŠ¨å…´è¶£ï¼`;
                } else {
                    suggestion = `æ¯ä¸ªå­©å­éƒ½æ˜¯å¾…å‘æ˜çš„å®è—ï¼è¿™ä¸ªå°æµ‹è¯•åªæ˜¯ä¸€ä¸ªå¼€å§‹ã€‚æˆ‘ä»¬çš„ã€è·³ç»³ä½“èƒ½è¯¾ã€‘éå¸¸é€‚åˆé›¶åŸºç¡€çš„å­©å­ï¼Œè¯¾ç¨‹å……æ»¡è¶£å‘³æ€§ï¼Œèƒ½å¸®ä»–å»ºç«‹è‡ªä¿¡ï¼Œçˆ±ä¸Šè¿åŠ¨ï¼Œå¥åº·æˆé•¿ï¼`;
                }
            } else {
                 if (totalScore > 60) {
                    suggestion = `ä½ çš„è¿åŠ¨å¤©èµ‹å¾ˆæ£’ï¼ä¿æŒè¿åŠ¨æ˜¯ç»´æŒæ´»åŠ›çš„æœ€ä½³æ–¹å¼ã€‚æˆ‘ä»¬çš„ã€å„¿ç«¥è·³ç»³ä½“èƒ½ã€‘è¯¾ç¨‹ä½“ç³»éå¸¸ç§‘å­¦ï¼Œæ¬¢è¿å¸¦å­©å­ä¸€èµ·æ¥ä½“éªŒè¿åŠ¨çš„å¿«ä¹ï¼Œè§è¯ä»–çš„æˆé•¿ä¸èœ•å˜ï¼`;
                } else {
                    suggestion = `æ²¡å…³ç³»ï¼Œè¿™åªæ˜¯ä¸ªå°æ¸¸æˆï¼é‡è¦çš„æ˜¯å¼€å§‹è¿åŠ¨çš„å†³å¿ƒã€‚æˆ‘ä»¬çš„ã€å„¿ç«¥è·³ç»³ä½“èƒ½ã€‘è¯¾ç¨‹éå¸¸æœ‰è¶£ï¼Œèƒ½è®©å­©å­ä»å°çˆ±ä¸Šè¿åŠ¨ï¼Œæ¬¢è¿å¸¦ä»–æ¥ä½“éªŒï¼Œä¸€èµ·è§è¯æˆé•¿ï¼`;
                }
            }
            
            resultTitle.textContent = title;
            resultDescription.textContent = description;
            resultSuggestion.textContent = suggestion;
            dynamicShareText.textContent = generateShareText(title, totalScore, beatRatio);

            drawResultChart();
            updateLeaderboard();
            
            let spots = 7;
            spotsLeftEl.textContent = spots;
            setInterval(() => {
                if (spots > 3) {
                    spots--;
                    spotsLeftEl.textContent = spots;
                }
            }, 5000);
        }

        function generateShareText(title, score, beatRatio) {
             if (userType === 'child') {
                return `åˆšç»™å¨ƒæµ‹äº†ä¸€ä¸‹ï¼ŒAIç®—æ³•ç®—å‡ºä»–çš„è¿åŠ¨å¤©èµ‹æ˜¯â€œ${title}â€ï¼Œå‡»è´¥äº†${beatRatio}%çš„åŒé¾„äººï¼ä½ ä¹Ÿå¿«æ¥ç»™å­©å­æµ‹æµ‹ï¼Œçœ‹çœ‹ä»–çš„éšè—æ½œåŠ›æ˜¯ä»€ä¹ˆï¼è¿˜èƒ½æŠ½å¥–èµ¢å…è´¹è¯¾ï¼`;
            } else {
                return `æˆ‘çš„ååº”åŠ›æ˜¯ç‹è€…çº§ï¼æ‹¿åˆ°äº†${score}åˆ†ï¼Œç§°å·æ˜¯â€œ${title}â€ï¼Œä¸æœæ¥æˆ˜ï¼æ®è¯´åªæœ‰5%çš„äººèƒ½æ‹¿åˆ°â€œè¿åŠ¨å°è¶…äººâ€ç§°å·ï¼Œä½ æ•¢æŒ‘æˆ˜å—ï¼Ÿ`;
            }
        }

        // --- æ’è¡Œæ¦œé€»è¾‘ (MODIFIED) ---
        function updateLeaderboard() {
            leaderboardContainer.innerHTML = ''; 
            
            const avatars = {
                boy1: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class="w-8 h-8 rounded-full bg-blue-400 p-1"><path d="M50,1.5A48.5,48.5,0,1,0,98.5,50,48.55,48.55,0,0,0,50,1.5Zm0,90A41.5,41.5,0,1,1,91.5,50,41.55,41.55,0,0,1,50,91.5Z" fill="#fff"/><path d="M50,15.5a12,12,0,0,0-12,12v11a12,12,0,0,0,24,0v-11A12,12,0,0,0,50,15.5Z" fill="#e6a87e"/><path d="M50,22.5a5,5,0,0,0-5,5v3a5,5,0,0,0,10,0v-3A5,5,0,0,0,50,22.5Z" fill="#6a462f"/><path d="M35.5,58.5a1.5,1.5,0,0,0,1.5,1.5h26a1.5,1.5,0,0,0,0-3h-26A1.5,1.5,0,0,0,35.5,58.5Z" fill="#fff"/><circle cx="38.5" cy="48.5" r="3.5" fill="#fff"/><circle cx="61.5" cy="48.5" r="3.5" fill="#fff"/></svg>`,
                girl1: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class="w-8 h-8 rounded-full bg-pink-400 p-1"><path d="M50,1.5A48.5,48.5,0,1,0,98.5,50,48.55,48.55,0,0,0,50,1.5Zm0,90A41.5,41.5,0,1,1,91.5,50,41.55,41.55,0,0,1,50,91.5Z" fill="#fff"/><path d="M50,15.5a12,12,0,0,0-12,12v11a12,12,0,0,0,24,0v-11A12,12,0,0,0,50,15.5Z" fill="#f2c8a7"/><path d="M62,18.5a6,6,0,1,0-12,0,1,1,0,0,0,2,0,4,4,0,1,1,8,0,1,1,0,0,0,2,0Z" fill="#c75b69"/><path d="M38,18.5a6,6,0,1,0-12,0,1,1,0,0,0,2,0,4,4,0,1,1,8,0,1,1,0,0,0,2,0Z" fill="#c75b69"/><path d="M50,22.5a5,5,0,0,0-5,5v3a5,5,0,0,0,10,0v-3A5,5,0,0,0,50,22.5Z" fill="#8c5a3c"/><path d="M35.5,60.5a1.5,1.5,0,0,0,1.5,1.5h26a1.5,1.5,0,0,0,0-3h-26A1.5,1.5,0,0,0,35.5,60.5Z" fill="#fff"/><circle cx="38.5" cy="48.5" r="3.5" fill="#fff"/><circle cx="61.5" cy="48.5" r="3.5" fill="#fff"/></svg>`,
                boy2: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" class="w-8 h-8 rounded-full bg-green-400 p-1"><path d="M50,1.5A48.5,48.5,0,1,0,98.5,50,48.55,48.55,0,0,0,50,1.5Zm0,90A41.5,41.5,0,1,1,91.5,50,41.55,41.55,0,0,1,50,91.5Z" fill="#fff"/><path d="M50,15.5a12,12,0,0,0-12,12v11a12,12,0,0,0,24,0v-11A12,12,0,0,0,50,15.5Z" fill="#d4a17d"/><path d="M50,22.5a5,5,0,0,0-5,5v3a5,5,0,0,0,10,0v-3A5,5,0,0,0,50,22.5Z" fill="#4a3524"/><path d="M35.5,58.5a1.5,1.5,0,0,0,1.5,1.5h26a1.5,1.5,0,0,0,0-3h-26A1.5,1.5,0,0,0,35.5,58.5Z" fill="#fff"/><circle cx="38.5" cy="48.5" r="3.5" fill="#fff"/><circle cx="61.5" cy="48.5" r="3.5" fill="#fff"/></svg>`
            };
            
            const thirdPlaceScore = Math.floor(Math.random() * (91 - 88 + 1)) + 88; // 88-91
            const fourthPlaceScore = Math.floor(Math.random() * (thirdPlaceScore - 1 - 85 + 1)) + 85; // 85 to thirdPlaceScore-1

            const fakePlayers = [
                { name: 'æ*é‘«', score: 96, avatar: 'boy1' },
                { name: 'é©¬*æ¢…', score: 92, avatar: 'girl1' },
                { name: 'ç‹*', score: thirdPlaceScore, avatar: 'boy2' },
                { name: 'èµµ*', score: fourthPlaceScore, avatar: 'girl1' }
            ];

            const currentUser = { name: 'æˆ‘', score: totalScore, avatar: 'trophy' };

            const renderPlayer = (player, rank) => {
                const rankItem = document.createElement('div');
                rankItem.className = `flex items-center p-2 rounded-lg ${player.name === 'æˆ‘' ? 'bg-orange-500/20' : 'bg-white/10'}`;
                const avatarHtml = player.name === 'æˆ‘' 
                    ? `<div class="w-8 h-8 rounded-full bg-amber-400 p-1 flex justify-center items-center">ğŸ†</div>` 
                    : avatars[player.avatar];
                rankItem.innerHTML = `
                    <span class="font-bold w-8">${rank}</span>
                    <div class="w-10 h-10 flex items-center justify-center">${avatarHtml}</div>
                    <span class="flex-grow font-semibold ml-2">${player.name}</span>
                    <span class="font-bold text-orange-500">${player.score} åˆ†</span>
                `;
                leaderboardContainer.appendChild(rankItem);
            };

            if (totalScore < 80) {
                // User score is low, show top 3 and user at a lower rank
                fakePlayers.slice(0, 3).forEach((player, index) => {
                    renderPlayer(player, index + 1);
                });

                const ellipsis = document.createElement('div');
                ellipsis.className = 'text-center text-gray-400 py-1';
                ellipsis.textContent = '...';
                leaderboardContainer.appendChild(ellipsis);

                const randomRank = Math.floor(Math.random() * (15 - 8 + 1)) + 8; // Random rank between 8 and 15
                renderPlayer(currentUser, randomRank);

            } else {
                // User score is high, show actual rank
                const allPlayers = [...fakePlayers, currentUser].sort((a, b) => b.score - a.score);
                allPlayers.forEach((player, index) => {
                    renderPlayer(player, index + 1);
                });
            }
        }

        // --- ç»˜åˆ¶é›·è¾¾å›¾ ---
        let resultChartInstance;
        function drawResultChart() {
            const ctx = document.getElementById('result-chart').getContext('2d');
            if (resultChartInstance) {
                resultChartInstance.destroy();
            }
            Chart.defaults.color = '#475569'; // text-slate-600
            Chart.defaults.font.family = "'Noto Sans SC', sans-serif";
            resultChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['æ•æ·', 'è€åŠ›', 'æ—¶æœº', 'åè°ƒ', 'åŠ›é‡'],
                    datasets: [{
                        label: 'æˆ‘çš„è¿åŠ¨æ½œèƒ½',
                        data: [
                            scores.agility, 
                            scores.endurance, 
                            scores.timing,
                            (scores.agility + scores.timing) / 2, 
                            (scores.endurance + scores.timing) / 2.2
                        ],
                        backgroundColor: 'rgba(249, 115, 22, 0.2)',
                        borderColor: 'rgba(249, 115, 22, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(249, 115, 22, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            pointLabels: { color: '#334155', font: { size: 14 } },
                            ticks: {
                                color: '#64748b',
                                backdropColor: 'transparent',
                                stepSize: 25
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#334155'
                            }
                        }
                    }
                }
            });
        }

        // --- æŠ½å¥–é€»è¾‘ ---
        // MODIFIED: æ›´æ–°å¥–å“åç§°å’Œæ¦‚ç‡
        const prizes = [
            { text: 'ä¸€ä¸ªæœˆå…è´¹è¯¾', prob: 2 }, 
            { text: 'å¹¸è¿å‚¨å¤‡ä¸­', prob: 33 }, 
            { text: 'ä¸“ä¸šç«é€Ÿè·³ç»³', prob: 10 },
            { text: 'åˆ†äº«å†æŠ½ä¸€æ¬¡', prob: 25 }, 
            { text: 'é™é‡ç¤¼ç›’', prob: 10 }, 
            { text: '100å…ƒä»£é‡‘åˆ¸', prob: 20 }
        ];
        let isSpinning = false;
        let spinCount = 0;
        
        function setupLotteryWheel() {
            lotteryWheel.innerHTML = '';
            prizes.forEach((prize, i) => {
                const rotation = i * 60 + 30; // FIX: æ—‹è½¬30åº¦ï¼Œä½¿æ–‡å­—å±…ä¸­
                const prizeElement = document.createElement('div');
                prizeElement.className = 'prize';
                prizeElement.style.transform = `rotate(${rotation}deg)`;
                prizeElement.innerHTML = `<span class="prize-text">${prize.text}</span>`;
                lotteryWheel.appendChild(prizeElement);
            });
        }

        function spinWheel() {
            if (isSpinning || spinCount >= 2) return;
            
            spinCount++;
            localStorage.setItem('spinCount', spinCount);

            isSpinning = true;
            lotteryResult.textContent = '';
            closeLotteryModalBtn.classList.add('hidden');
            
            // æƒé‡æŠ½å¥–ç®—æ³•
            const totalProb = prizes.reduce((sum, p) => sum + p.prob, 0);
            let random = Math.random() * totalProb;
            let winningPrize;
            let prizeIndex = 0;
            for(const prize of prizes) {
                random -= prize.prob;
                if (random <= 0) {
                    winningPrize = prize;
                    break;
                }
                prizeIndex++;
            }

            const randomOffset = Math.random() * 40 - 20; // -20 to 20 degrees offset
            const stopAngle = (prizeIndex * 60) + 30 + randomOffset;
            const randomExtraTurns = Math.floor(Math.random() * 4) + 3; 
            const totalRotation = randomExtraTurns * 360 + (360 - stopAngle);

            lotteryWheel.style.transform = `rotate(${totalRotation}deg)`;

            setTimeout(() => {
                lotteryResult.textContent = `æ­å–œä½ æŠ½ä¸­ã€${winningPrize.text}ã€‘!`;
                
                // MODIFIED: ä¸­å¥–åå¢åŠ åˆ†äº«æç¤º
                if (winningPrize.text !== 'å¹¸è¿å‚¨å¤‡ä¸­' && winningPrize.text !== 'åˆ†äº«å†æŠ½ä¸€æ¬¡') {
                    lotteryResult.textContent += ' æ™’å›¾+@æˆ‘ä»¬ï¼Œé€é™é‡è·³ç»³è¢‹ï¼';
                     setTimeout(() => {
                        alert('å¤ªæ£’äº†ï¼å¿«åˆ†äº«ç»™æœ‹å‹ï¼Œè®©ä»–ä»¬ä¹Ÿæ¥æŒ‘æˆ˜èµ¢å¥–å“å§ï¼');
                    }, 500);
                } else if (winningPrize.text === 'åˆ†äº«å†æŠ½ä¸€æ¬¡') {
                    lotteryResult.textContent = 'å·®ä¸€ç‚¹ï¼åˆ†äº«ç»™å¥½å‹å¯å†æŠ½ä¸€æ¬¡ï¼';
                    isSpinning = false;
                    // é‡ç½®æŒ‰é’®çŠ¶æ€ä»¥å…è®¸ç¬¬äºŒæ¬¡æŠ½å¥–
                    spinBtn.disabled = false;
                    spinBtn.textContent = 'å†æŠ½ä¸€æ¬¡';
                    spinBtn.classList.remove('bg-gray-500');
                    return; 
                }
                
                isSpinning = false;
                closeLotteryModalBtn.classList.remove('hidden');
                spinBtn.disabled = true;
                spinBtn.textContent = 'å·²æŠ½';
                spinBtn.classList.add('bg-gray-500');

            }, 5000); 
        }

        // --- äº‹ä»¶ç›‘å¬ ---
        startBtn.addEventListener('click', () => {
            initAudio(); 
            synth.triggerAttackRelease("C4", "8n");
            showPage('choice-page');
        });

        choiceBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                synth.triggerAttackRelease("E4", "8n");
                userType = btn.dataset.type;
                showPage('challenge-page');
                startNextChallenge();
            });
        });

        openLeadFormBtn.addEventListener('click', () => {
            toggleModal(leadFormModal, true)
        });
        
        openShareModalBtn.addEventListener('click', () => {
            if (isShareInstructed) {
                toggleModal(lotteryModal, true);
            } else {
                toggleModal(shareModal, true);
            }
        });

        closeShareModalBtn.addEventListener('click', () => toggleModal(shareModal, false));
        closeQrcodeModalBtn.addEventListener('click', () => toggleModal(leadFormModal, false));
        
        shareNowBtn.addEventListener('click', () => {
            alert('è¯·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«ç»™å¥½å‹æˆ–æœ‹å‹åœˆï¼åˆ†äº«æˆåŠŸåï¼ŒæŠ½å¥–æœºä¼šå°†è‡ªåŠ¨æ¿€æ´»ï¼');
            toggleModal(shareModal, false);
            isShareInstructed = true;
            openShareModalBtn.textContent = 'å¼€å§‹æŠ½å¥–';
        });

        shareTextContainer.addEventListener('click', () => {
            const textToCopy = dynamicShareText.textContent;
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('æ–‡æ¡ˆå·²å¤åˆ¶ï¼');
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textArea);
        });

        spinBtn.addEventListener('click', spinWheel);
        closeLotteryModalBtn.addEventListener('click', () => toggleModal(lotteryModal, false));
        
        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            setupLotteryWheel();
            // åœ¨ä¸‹æ–¹çš„ "" ä¸­ç²˜è´´ä½ çš„äºŒç»´ç å›¾ç‰‡é“¾æ¥
            qrCodeImg.src = ""; 

            spinCount = parseInt(localStorage.getItem('spinCount') || '0');
            if (spinCount >= 2) {
                spinBtn.disabled = true;
                spinBtn.textContent = 'å·²æŠ½';
                spinBtn.classList.add('bg-gray-500');
            }
        });

    </script>
</body>
</html>

